<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´è‡ªå®šä¹‰æ ‡ç­¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-3px);
        }
        
        .card-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f3f5;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .tag-section {
            margin-top: 25px;
        }
        
        .tag-search-section {
            margin-bottom: 15px;
        }
        
        .tag-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .tag-chip {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .tag-chip:hover {
            background: #d5dbdb;
        }
        
        .tag-chip.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .quick-tag {
            background: #fff3cd;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid #ffeaa7;
            transition: all 0.2s;
        }
        
        .quick-tag:hover {
            background: #ffeaa7;
        }
        
        .selected-tags {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .selected-tags-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .selected-tags-list {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .create-tag-section {
            border: 1px dashed #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            background: #f8f9fa;
        }
        
        .create-tag-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .create-tag-subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .create-tag-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .new-tag-input {
            flex: 3;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .add-tag-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .add-tag-btn:hover {
            background: #2980b9;
        }
        
        .add-tag-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .new-tag-preview {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
        
        .submit-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .book-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .book-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }
        
        .book-item:hover {
            background-color: #f8f9fa;
        }
        
        .book-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .book-meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .book-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #495057;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #bdc3c7;
        }
        
        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .book-exists-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .existing-book-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .existing-book-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #856404;
        }
        
        .update-book-btn {
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .update-book-btn:hover {
            background: #e67e22;
        }
        
        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        .search-result-category {
            font-size: 0.75rem;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
        }
    </style>
    
    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š å°è¯´è‡ªå®šä¹‰æ ‡ç­¾ç³»ç»Ÿ</h1>
            <p class="subtitle">æ·»åŠ æ‚¨å–œæ¬¢çš„å°è¯´çš„æ ‡ç­¾ä¿¡æ¯å§ <span id="connection-status" class="connection-status status-disconnected">æœªè¿æ¥</span></p>
        </header>
        
        <div class="main-content">
            <!-- å·¦ä¾§ï¼šæ·»åŠ å°è¯´è¡¨å• -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-book"></i> æ·»åŠ æ–°å°è¯´</h2>
                
                <form id="book-form">
                    <div class="form-group">
                        <label for="title">ä¹¦å *</label>
                        <input type="text" id="title" required placeholder="è¯·è¾“å…¥å°è¯´ä¹¦å">
                        <div id="book-exists-message" class="book-exists-message"></div>
                    </div>
                    
                    <div id="existing-book-info" class="existing-book-info">
                        <div class="existing-book-title">ã€Š<span id="existing-book-name"></span>ã€‹å·²å­˜åœ¨äºæ•°æ®åº“ä¸­</div>
                        <div id="existing-book-details"></div>
                        <button type="button" id="update-book-btn" class="update-book-btn">æ›´æ–°ä¹¦ç±ä¿¡æ¯</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="author">ä½œè€…</label>
                        <input type="text" id="author" placeholder="è¯·è¾“å…¥ä½œè€…å§“å">
                    </div>
                    
                    <div class="form-group">
                        <label for="platform">å‘å¸ƒå¹³å°</label>
                        <select id="platform">
                            <option value="">è¯·é€‰æ‹©å¹³å°</option>
                            <option value="èµ·ç‚¹">èµ·ç‚¹ä¸­æ–‡ç½‘</option>
                            <option value="æ™‹æ±Ÿ">æ™‹æ±Ÿæ–‡å­¦åŸ</option>
                            <option value="çºµæ¨ª">çºµæ¨ªä¸­æ–‡ç½‘</option>
                            <option value="ç•ªèŒ„">ç•ªèŒ„å°è¯´</option>
                            <option value="ä¸ƒçŒ«">ä¸ƒçŒ«å°è¯´</option>
                            <option value="å…¶ä»–">å…¶ä»–å¹³å°</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">å°è¯´ç®€ä»‹</label>
                        <textarea id="description" placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™æœ¬å°è¯´çš„ä¸»è¦å†…å®¹..."></textarea>
                    </div>
                    
                    <!-- æ ‡ç­¾é€‰æ‹©åŒºåŸŸ -->
                    <div class="tag-section">
                        <h3>ğŸ·ï¸ é€‰æ‹©æ ‡ç­¾</h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">é€‰æ‹©é€‚åˆè¿™æœ¬å°è¯´çš„æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰</p>
                        
                        <!-- æ ‡ç­¾æœç´¢ -->
                        <div class="tag-search-section">
                            <input type="text" id="tag-search" class="tag-search-input" placeholder="æœç´¢æ ‡ç­¾...">
                            <div id="search-results" class="tag-suggestions"></div>
                        </div>

                        <!-- å¿«é€Ÿå¸¸ç”¨æ ‡ç­¾ -->
                        <div class="quick-tags" id="quick-tags">
                            <div style="color: #666; width: 100%;">å¸¸ç”¨æ ‡ç­¾åŠ è½½ä¸­...</div>
                        </div>

                        <!-- æ ‡ç­¾åˆ†ç±»æ˜¾ç¤º -->
                        <div id="tag-suggestions">
                            <div style="color: #666;">åŠ è½½æ ‡ç­¾ä¸­...</div>
                        </div>
                        
                        <div class="selected-tags">
                            <div class="selected-tags-title">å·²é€‰æ ‡ç­¾ï¼š</div>
                            <div id="selected-tags-list" class="selected-tags-list">æš‚æ— </div>
                        </div>
                    </div>

                    <!-- åˆ›å»ºæ–°æ ‡ç­¾åŒºåŸŸ - å·²ç®€åŒ– -->
                    <div class="create-tag-section">
                        <h4 class="create-tag-title">â• åˆ›å»ºæ–°æ ‡ç­¾</h4>
                        <p class="create-tag-subtitle">è¾“å…¥æ ‡ç­¾åç§°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†ç±»</p>
                        
                        <div class="create-tag-input">
                            <input type="text" id="new-tag-name" class="new-tag-input" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°">
                            <button type="button" id="add-tag-btn" class="add-tag-btn">åˆ›å»º</button>
                        </div>
                        
                        <div id="auto-category-preview" class="new-tag-preview">
                            <strong>ç³»ç»Ÿåˆ†ç±»ï¼š</strong>
                            <span id="predicted-category">æ­£åœ¨åˆ†æ...</span>
                        </div>
                        
                        <div id="create-tag-message" style="margin-top: 10px; font-size: 14px;"></div>
                    </div>
                    
                    <button type="submit" id="submit-btn" class="submit-btn">æäº¤å°è¯´ä¿¡æ¯</button>
                </form>
                
                <div id="message" class="message"></div>
            </div>
            
            <!-- å³ä¾§ï¼šå°è¯´åˆ—è¡¨ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-list"></i> å·²æ·»åŠ çš„å°è¯´</h2>
                <div class="book-list" id="book-list">
                    <div class="empty-state">
                        <i class="fas fa-book-open"></i>
                        <p>æš‚æ— å°è¯´ä¿¡æ¯</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">æ·»åŠ çš„å°è¯´å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨å…¨å±€å˜é‡
        window.supabaseClient = null;
        window.selectedTags = [];
        window.newlyCreatedTags = [];
        window.books = [];
        window.existingBook = null;

        // åˆå§‹åŒ–Supabase
        async function initSupabase() {
            try {
                const supabaseUrl = 'https://clwpzlioymonhhuelptk.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsd3B6bGlveW1vbmhodWVscHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MjgzMDQsImV4cCI6MjA3ODUwNDMwNH0.YZ58wm9t-XfEwMd9xylfDI4dcOxdDBaZQOYFRsYHrPs';
                
                window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                
                // æµ‹è¯•è¿æ¥
                const { data, error } = await window.supabaseClient
                    .from('books')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.getElementById('connection-status').className = 'connection-status status-connected';
                console.log('Supabaseè¿æ¥æˆåŠŸ');
                return true;
                
            } catch (error) {
                console.error('Supabaseè¿æ¥å¤±è´¥:', error);
                document.getElementById('connection-status').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('connection-status').className = 'connection-status status-disconnected';
                return false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–Supabase
            const connected = await initSupabase();
            
            if (connected) {
                await loadPopularTags();
                await loadQuickTags();
                await loadBooks();
            } else {
                document.getElementById('tag-suggestions').innerHTML = 
                    '<div style="color: red;">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢</div>';
                document.getElementById('submit-btn').disabled = true;
            }
            
            setupEventListeners();
        });

        // æ£€æŸ¥ä¹¦åæ˜¯å¦å­˜åœ¨
        async function checkBookExists(title) {
            if (!title || title.length < 1) {
                return null;
            }
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('books')
                    .select(`
                        *,
                        book_tags (
                            tags (
                                id,
                                name,
                                category
                            )
                        )
                    `)
                    .ilike('title', title)
                    .limit(1);
                
                if (error) throw error;
                
                return data && data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('æ£€æŸ¥ä¹¦åå¤±è´¥:', error);
                return null;
            }
        }

        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        async function checkTagExists(tagName) {
            if (!tagName || tagName.length < 1) {
                return null;
            }
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('tags')
                    .select('*')
                    .ilike('name', tagName)
                    .limit(1);
                
                if (error) throw error;
                
                return data && data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('æ£€æŸ¥æ ‡ç­¾å¤±è´¥:', error);
                return null;
            }
        }

        // æ™ºèƒ½åˆ†ç±»é¢„æµ‹
        async function predictCategory(tagName) {
            if (!tagName) return 'å…¶ä»–';
            
            // æ£€æŸ¥ç°æœ‰æ ‡ç­¾çš„åˆ†ç±»
            const existingTag = await checkTagExists(tagName);
            if (existingTag) {
                return existingTag.category;
            }
            
            // åŸºäºå…³é”®è¯çš„åˆ†ç±»é¢„æµ‹
            const categoryKeywords = {
                'æ ¸å¿ƒè®¾å®š': ['ç©¿è¶Š', 'é‡ç”Ÿ', 'ç³»ç»Ÿ', 'æœ«ä¸–', 'æ˜Ÿé™…', 'ç„å¹»', 'ä»™ä¾ ', 'æ­¦ä¾ ', 'ç§‘å¹»', 'ç°ä»£', 'å¤ä»£', 'æœªæ¥', 'æ¶ç©º', 'å¼‚ä¸–ç•Œ', 'å¿«ç©¿'],
                'æ„Ÿæƒ…æ¨¡å¼': ['ç”œå® ', 'è™æ‹', 'æš—æ‹', 'å…ˆå©šåçˆ±', 'ç ´é•œé‡åœ†', 'é’æ¢…ç«¹é©¬', 'åŒå‘æš—æ‹', 'è¿½å¦»ç«è‘¬åœº', 'å¼ºå–è±ªå¤º', 'æ—¥ä¹…ç”Ÿæƒ…', 'ä¸€è§é’Ÿæƒ…'],
                'äººç‰©å…³ç³»': ['1v1', 'ç¾¤åƒ', 'å…„å¼Ÿ', 'å§å¦¹', 'å¸ˆå¾’', 'ä¸»ä»†', 'å¼ºå¼º', 'å¥³ç‹', 'å¿ çŠ¬', 'å¹´ä¸Š', 'å¹´ä¸‹', 'åŒå‘å¥”èµ´'],
                'å™äº‹é£æ ¼': ['è½»æ¾', 'æ­£å‰§', 'æç¬‘', 'æ‚¬ç–‘', 'ææ€–', 'æ²»æ„ˆ', 'æ²™é›•', 'æ…¢çƒ­', 'å¿«èŠ‚å¥', 'æ¸©é¦¨', 'è‡´éƒ'],
                'é˜…è¯»æç¤º': ['HE', 'BE', 'SC', 'é«˜H', 'æ¸…æ°´', 'å®Œç»“', 'è¿è½½', 'ç•ªå¤–', 'åŒæ´', 'é›·ç‚¹']
            };
            
            const lowerTagName = tagName.toLowerCase();
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => lowerTagName.includes(keyword.toLowerCase()))) {
                    return category;
                }
            }
            
            return 'å…¶ä»–';
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const form = document.getElementById('book-form');
            form.addEventListener('submit', handleFormSubmit);
            
            // ä¹¦åè¾“å…¥æ£€æŸ¥
            const titleInput = document.getElementById('title');
            let checkTimeout;
            titleInput.addEventListener('input', function() {
                clearTimeout(checkTimeout);
                checkTimeout = setTimeout(async () => {
                    const title = this.value.trim();
                    if (title.length > 0) {
                        window.existingBook = await checkBookExists(title);
                        if (window.existingBook) {
                            showBookExistsMessage(window.existingBook);
                        } else {
                            hideBookExistsMessage();
                        }
                    } else {
                        hideBookExistsMessage();
                    }
                }, 500);
            });
            
            // æ ‡ç­¾æœç´¢
            const tagSearch = document.getElementById('tag-search');
            tagSearch.addEventListener('input', handleTagSearch);
            
            // åˆ›å»ºæ–°æ ‡ç­¾
            const addTagBtn = document.getElementById('add-tag-btn');
            addTagBtn.addEventListener('click', handleCreateNewTag);
            
            // å®æ—¶åˆ†ç±»é¢„è§ˆ
            const newTagName = document.getElementById('new-tag-name');
            newTagName.addEventListener('input', async function() {
                const tagName = this.value.trim();
                const preview = document.getElementById('auto-category-preview');
                
                if (tagName) {
                    const predictedCategory = await predictCategory(tagName);
                    document.getElementById('predicted-category').textContent = predictedCategory;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
            
            // æ›´æ–°ç°æœ‰ä¹¦ç±æŒ‰é’®
            const updateBookBtn = document.getElementById('update-book-btn');
            updateBookBtn.addEventListener('click', handleUpdateExistingBook);
        }

        // æ˜¾ç¤ºä¹¦ç±å·²å­˜åœ¨æ¶ˆæ¯
        function showBookExistsMessage(book) {
            const messageDiv = document.getElementById('book-exists-message');
            const existingBookInfo = document.getElementById('existing-book-info');
            const existingBookName = document.getElementById('existing-book-name');
            const existingBookDetails = document.getElementById('existing-book-details');
            
            messageDiv.textContent = 'æ­¤ä¹¦å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œæ‚¨å¯ä»¥æ›´æ–°ä¿¡æ¯æˆ–æ·»åŠ æ ‡ç­¾';
            messageDiv.style.display = 'block';
            
            existingBookName.textContent = book.title;
            
            // å¡«å……ç°æœ‰æ•°æ®åˆ°è¡¨å•
            document.getElementById('author').value = book.author || '';
            document.getElementById('platform').value = book.platform || '';
            document.getElementById('description').value = book.description || '';
            
            // è®¾ç½®ç°æœ‰æ ‡ç­¾åˆ°é€‰ä¸­åˆ—è¡¨
            window.selectedTags = [];
            if (book.book_tags && book.book_tags.length > 0) {
                book.book_tags.forEach(bt => {
                    window.selectedTags.push(bt.tags);
                });
            }
            updateSelectedTagsDisplay();
            
            // æ›´æ–°æ ‡ç­¾é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.tag-chip').forEach(el => {
                el.classList.remove('selected');
            });
            window.selectedTags.forEach(tag => {
                const tagElement = document.querySelector(`.tag-chip[data-tag-id="${tag.id}"]`);
                if (tagElement) {
                    tagElement.classList.add('selected');
                }
            });
            
            let detailsHtml = '';
            if (book.author) detailsHtml += `<div>ä½œè€…: ${book.author}</div>`;
            if (book.platform) detailsHtml += `<div>å¹³å°: ${book.platform}</div>`;
            if (book.book_tags && book.book_tags.length > 0) {
                detailsHtml += `<div>ç°æœ‰æ ‡ç­¾: ${book.book_tags.map(bt => bt.tags.name).join(', ')}</div>`;
            }
            
            existingBookDetails.innerHTML = detailsHtml;
            existingBookInfo.style.display = 'block';
            
            // ä¿®æ”¹æäº¤æŒ‰é’®æ–‡æœ¬
            document.getElementById('submit-btn').textContent = 'æ›´æ–°ä¹¦ç±ä¿¡æ¯';
        }

        // éšè—ä¹¦ç±å·²å­˜åœ¨æ¶ˆæ¯
        function hideBookExistsMessage() {
            const messageDiv = document.getElementById('book-exists-message');
            const existingBookInfo = document.getElementById('existing-book-info');
            
            messageDiv.style.display = 'none';
            existingBookInfo.style.display = 'none';
            window.existingBook = null;
            
            // æ¢å¤æäº¤æŒ‰é’®æ–‡æœ¬
            document.getElementById('submit-btn').textContent = 'æäº¤å°è¯´ä¿¡æ¯';
        }

        // æ›´æ–°ç°æœ‰ä¹¦ç±ä¿¡æ¯
        async function handleUpdateExistingBook() {
            if (!window.existingBook) {
                showMessage('æœªæ‰¾åˆ°è¦æ›´æ–°çš„ä¹¦ç±', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'æ›´æ–°ä¸­...';
            submitBtn.disabled = true;
            
            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const updateData = {
                    author: document.getElementById('author').value.trim(),
                    platform: document.getElementById('platform').value,
                    description: document.getElementById('description').value.trim()
                };
                
                console.log('æ›´æ–°ä¹¦ç±æ•°æ®:', updateData);
                
                // 1. æ›´æ–°ä¹¦ç±ä¿¡æ¯
                const { error: bookError } = await window.supabaseClient
                    .from('books')
                    .update(updateData)
                    .eq('id', window.existingBook.id);
                
                if (bookError) throw bookError;
                
                // 2. å¤„ç†æ ‡ç­¾å…³è”
                const currentTagIds = window.selectedTags.map(tag => tag.id);
                const existingTagIds = window.existingBook.book_tags ? 
                    window.existingBook.book_tags.map(bt => bt.tags.id) : [];
                
                // æ‰¾å‡ºè¦æ·»åŠ çš„æ ‡ç­¾
                const tagsToAdd = currentTagIds.filter(id => !existingTagIds.includes(id));
                // æ‰¾å‡ºè¦åˆ é™¤çš„æ ‡ç­¾
                const tagsToRemove = existingTagIds.filter(id => !currentTagIds.includes(id));
                
                console.log('è¦æ·»åŠ çš„æ ‡ç­¾:', tagsToAdd);
                console.log('è¦åˆ é™¤çš„æ ‡ç­¾:', tagsToRemove);
                
                // æ·»åŠ æ–°æ ‡ç­¾å…³è”
                if (tagsToAdd.length > 0) {
                    const bookTagInserts = tagsToAdd.map(tagId => ({
                        book_id: window.existingBook.id,
                        tag_id: tagId
                    }));
                    
                    const { error: addError } = await window.supabaseClient
                        .from('book_tags')
                        .insert(bookTagInserts);
                    
                    if (addError) throw addError;
                }
                
                // åˆ é™¤ä¸å†å…³è”çš„æ ‡ç­¾
                if (tagsToRemove.length > 0) {
                    const { error: removeError } = await window.supabaseClient
                        .from('book_tags')
                        .delete()
                        .eq('book_id', window.existingBook.id)
                        .in('tag_id', tagsToRemove);
                    
                    if (removeError) throw removeError;
                }
                
                showMessage(`âœ… æˆåŠŸæ›´æ–°ã€Š${window.existingBook.title}ã€‹çš„ä¿¡æ¯`, 'success');
                
                // æ¸…ç©ºè¡¨å•å’ŒçŠ¶æ€
                document.getElementById('book-form').reset();
                window.selectedTags = [];
                updateSelectedTagsDisplay();
                document.querySelectorAll('.tag-chip.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                hideBookExistsMessage();
                
                // é‡æ–°åŠ è½½ä¹¦ç±åˆ—è¡¨
                await loadBooks();
                
            } catch (error) {
                console.error('æ›´æ–°ä¹¦ç±å¤±è´¥:', error);
                showMessage('æ›´æ–°å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // åŠ è½½çƒ­é—¨æ ‡ç­¾
        async function loadPopularTags() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('tags')
                    .select('*')
                    .order('used_count', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                displayTagSuggestions(data);
                
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
                document.getElementById('tag-suggestions').innerHTML = 
                    '<div style="color: red;">åŠ è½½æ ‡ç­¾å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }

        // åŠ è½½å¿«é€Ÿå¸¸ç”¨æ ‡ç­¾
        async function loadQuickTags() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('tags')
                    .select('*')
                    .order('used_count', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                displayQuickTags(data);
                
            } catch (error) {
                console.error('åŠ è½½å¿«é€Ÿæ ‡ç­¾å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå¿«é€Ÿæ ‡ç­¾
        function displayQuickTags(tags) {
            const container = document.getElementById('quick-tags');
            container.innerHTML = '<div style="color: #666; width: 100%; margin-bottom: 8px;">å¸¸ç”¨æ ‡ç­¾ï¼š</div>';

            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'quick-tag';
                tagElement.textContent = tag.name;
                tagElement.title = `${tag.name} (${tag.category})`;
                tagElement.addEventListener('click', () => addExistingTag(tag));
                container.appendChild(tagElement);
            });
        }

        // æ·»åŠ ç°æœ‰æ ‡ç­¾åˆ°é€‰ä¸­åˆ—è¡¨
        function addExistingTag(tag) {
            const index = window.selectedTags.findIndex(t => t.id === tag.id);
            if (index === -1) {
                window.selectedTags.push(tag);
                updateSelectedTagsDisplay();
                showCreateTagMessage(`å·²æ·»åŠ æ ‡ç­¾: ${tag.name}`, 'success');
            }
        }

        // æ˜¾ç¤ºæ ‡ç­¾å»ºè®®
        function displayTagSuggestions(tags) {
            const container = document.getElementById('tag-suggestions');
            container.innerHTML = '';

            // æŒ‰åˆ†ç±»åˆ†ç»„
            const tagsByCategory = {};
            tags.forEach(tag => {
                if (!tagsByCategory[tag.category]) {
                    tagsByCategory[tag.category] = [];
                }
                tagsByCategory[tag.category].push(tag);
            });

            // ä¸ºæ¯ä¸ªåˆ†ç±»åˆ›å»ºæ ‡ç­¾ç»„
            Object.keys(tagsByCategory).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.marginBottom = '20px';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);

                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'tag-suggestions';

                tagsByCategory[category].forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag-chip';
                    tagElement.textContent = tag.name;
                    tagElement.title = `${tag.name} (${tag.category})`;
                    tagElement.setAttribute('data-tag-id', tag.id);
                    tagElement.addEventListener('click', () => toggleTag(tag, tagElement));
                    tagsContainer.appendChild(tagElement);
                });

                categoryDiv.appendChild(tagsContainer);
                container.appendChild(categoryDiv);
            });
        }

        // æ ‡ç­¾æœç´¢å¤„ç†
        async function handleTagSearch(event) {
            const searchTerm = event.target.value.trim();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm.length < 1) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('tags')
                    .select('*')
                    .ilike('name', `%${searchTerm}%`)
                    .limit(10);
                
                if (error) throw error;
                
                displaySearchResults(data, resultsContainer);
                
            } catch (error) {
                console.error('æœç´¢æ ‡ç­¾å¤±è´¥:', error);
                resultsContainer.innerHTML = '<div style="color: red;">æœç´¢å¤±è´¥</div>';
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(tags, container) {
            if (tags.length === 0) {
                container.innerHTML = '<div style="color: #666; padding: 10px;">æœªæ‰¾åˆ°ç›¸å…³æ ‡ç­¾</div>';
                return;
            }
            
            container.innerHTML = '';
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'search-result-item';
                tagElement.innerHTML = `
                    <div>
                        <strong>${tag.name}</strong>
                        <div class="search-result-category">${tag.category}</div>
                    </div>
                    <div style="color: #6c757d; font-size: 0.8rem;">ç‚¹å‡»æ·»åŠ </div>
                `;
                tagElement.addEventListener('click', () => addExistingTag(tag));
                container.appendChild(tagElement);
            });
        }

        // åˆ›å»ºæ–°æ ‡ç­¾å¤„ç†
        async function handleCreateNewTag() {
            const nameInput = document.getElementById('new-tag-name');
            let tagName = nameInput.value.trim();
            
            if (!tagName) {
                showCreateTagMessage('è¯·è¾“å…¥æ ‡ç­¾åç§°', 'error');
                return;
            }
            
            if (tagName.length > 20) {
                showCreateTagMessage('æ ‡ç­¾åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºå·²é€‰æ ‡ç­¾ä¸­
            const existsInSelected = window.selectedTags.some(tag => tag.name === tagName);
            if (existsInSelected) {
                showCreateTagMessage('è¯¥æ ‡ç­¾å·²å­˜åœ¨äºå·²é€‰æ ‡ç­¾ä¸­', 'error');
                return;
            }
            
            // é¢„æµ‹åˆ†ç±»
            const predictedCategory = await predictCategory(tagName);
            
            // æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥æ ‡ç­¾
            const existingTag = await checkTagExists(tagName);
            if (existingTag) {
                showCreateTagMessage(`æ ‡ç­¾ "${tagName}" å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œå·²è‡ªåŠ¨æ·»åŠ `, 'success');
                addExistingTag(existingTag);
                nameInput.value = '';
                document.getElementById('auto-category-preview').style.display = 'none';
                return;
            }
            
            // åˆ›å»ºæ–°æ ‡ç­¾
            try {
                const { data, error } = await window.supabaseClient
                    .from('tags')
                    .insert([{
                        name: tagName,
                        category: predictedCategory,
                        description: '',
                        used_count: 0
                    }])
                    .select();
                
                if (error) throw error;
                
                const newTag = data[0];
                window.selectedTags.push(newTag);
                updateSelectedTagsDisplay();
                
                showCreateTagMessage(`âœ… å·²åˆ›å»ºæ ‡ç­¾: ${tagName} (${predictedCategory})`, 'success');
                nameInput.value = '';
                document.getElementById('auto-category-preview').style.display = 'none';
                
                // é‡æ–°åŠ è½½æ ‡ç­¾åˆ—è¡¨
                await loadPopularTags();
                await loadQuickTags();
                
            } catch (error) {
                console.error('åˆ›å»ºæ ‡ç­¾å¤±è´¥:', error);
                if (error.code === '23505') {
                    showCreateTagMessage('è¯¥æ ‡ç­¾å·²å­˜åœ¨', 'error');
                } else {
                    showCreateTagMessage('åˆ›å»ºæ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
                }
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºæ ‡ç­¾çš„æ¶ˆæ¯
        function showCreateTagMessage(text, type) {
            const messageDiv = document.getElementById('create-tag-message');
            messageDiv.textContent = text;
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.padding = '8px';
            messageDiv.style.borderRadius = '4px';
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©çŠ¶æ€
        function toggleTag(tag, element) {
            const index = window.selectedTags.findIndex(t => t.id === tag.id);
            
            if (index === -1) {
                window.selectedTags.push(tag);
                element.classList.add('selected');
            } else {
                window.selectedTags.splice(index, 1);
                element.classList.remove('selected');
            }
            
            updateSelectedTagsDisplay();
        }

        // æ›´æ–°å·²é€‰æ ‡ç­¾æ˜¾ç¤º
        function updateSelectedTagsDisplay() {
            const container = document.getElementById('selected-tags-list');
            
            if (window.selectedTags.length === 0) {
                container.textContent = 'æš‚æ— ';
                container.style.color = '#6c757d';
            } else {
                container.textContent = window.selectedTags.map(tag => tag.name).join(', ');
                container.style.color = '#000';
            }
        }

        // å¤„ç†è¡¨å•æäº¤
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            // å¦‚æœä¹¦ç±å·²å­˜åœ¨ï¼Œä½¿ç”¨æ›´æ–°é€»è¾‘
            if (window.existingBook) {
                await handleUpdateExistingBook();
                return;
            }
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'æäº¤ä¸­...';
            submitBtn.disabled = true;
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                title: document.getElementById('title').value.trim(),
                author: document.getElementById('author').value.trim(),
                platform: document.getElementById('platform').value,
                description: document.getElementById('description').value.trim(),
                submitted_by: 'user_' + Date.now()
            };
            
            // ç®€å•éªŒè¯
            if (!formData.title) {
                showMessage('è¯·å¡«å†™ä¹¦åï¼', 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            try {
                console.log('å¼€å§‹æäº¤æ•°æ®åˆ°Supabase...');
                
                // 1. æ’å…¥ä¹¦ç±æ•°æ®
                const { data: bookData, error: bookError } = await window.supabaseClient
                    .from('books')
                    .insert([formData])
                    .select();
                
                if (bookError) {
                    // å¦‚æœæ˜¯é‡å¤ä¹¦ç±é”™è¯¯
                    if (bookError.code === '23505') {
                        showMessage('æ­¤ä¹¦å·²å­˜åœ¨äºæ•°æ®åº“ä¸­', 'error');
                        // é‡æ–°æ£€æŸ¥ä¹¦ç±æ˜¯å¦å­˜åœ¨
                        window.existingBook = await checkBookExists(formData.title);
                        if (window.existingBook) {
                            showBookExistsMessage(window.existingBook);
                        }
                        return;
                    }
                    throw bookError;
                }
                
                const bookId = bookData[0].id;
                console.log('ä¹¦ç±æ’å…¥æˆåŠŸï¼ŒID:', bookId);
                
                // 2. å‡†å¤‡æ ‡ç­¾å…³è”
                const bookTagInserts = [];
                
                window.selectedTags.forEach(tag => {
                    bookTagInserts.push({
                        book_id: bookId,
                        tag_id: tag.id
                    });
                });
                
                console.log('å‡†å¤‡æ’å…¥çš„æ ‡ç­¾å…³è”:', bookTagInserts);
                
                // 3. æ’å…¥æ ‡ç­¾å…³è”
                if (bookTagInserts.length > 0) {
                    const { error: tagError } = await window.supabaseClient
                        .from('book_tags')
                        .insert(bookTagInserts);
                    
                    if (tagError) throw tagError;
                    console.log('æ ‡ç­¾å…³è”æ’å…¥æˆåŠŸ');
                }
                
                // æˆåŠŸæç¤º
                showMessage(`âœ… æˆåŠŸæ·»åŠ ã€Š${formData.title}ã€‹åˆ°æ•°æ®åº“ï¼`, 'success');
                
                // æ¸…ç©ºè¡¨å•å’ŒçŠ¶æ€
                document.getElementById('book-form').reset();
                window.selectedTags = [];
                updateSelectedTagsDisplay();
                document.querySelectorAll('.tag-chip.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // é‡æ–°åŠ è½½ä¹¦ç±åˆ—è¡¨
                await loadBooks();
                
            } catch (error) {
                console.error('æäº¤é”™è¯¯:', error);
                showMessage('æäº¤å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // åŠ è½½ä¹¦ç±åˆ—è¡¨
        async function loadBooks() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('books')
                    .select(`
                        *,
                        book_tags (
                            tags (
                                name,
                                category
                            )
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                window.books = data;
                displayBooks();
                
            } catch (error) {
                console.error('åŠ è½½ä¹¦ç±å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä½†ä¸æ¸…ç©ºåˆ—è¡¨
            }
        }

        // æ˜¾ç¤ºä¹¦ç±åˆ—è¡¨
        function displayBooks() {
            const container = document.getElementById('book-list');
            
            if (window.books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book-open"></i>
                        <p>æš‚æ— å°è¯´ä¿¡æ¯</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">æ·»åŠ çš„å°è¯´å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = window.books.map(book => `
                <div class="book-item">
                    <div class="book-title">ã€Š${book.title}ã€‹</div>
                    <div class="book-meta">
                        ${book.author ? `ä½œè€…ï¼š${book.author} | ` : ''}
                        ${book.platform ? `å¹³å°ï¼š${book.platform} | ` : ''}
                        æ·»åŠ æ—¶é—´ï¼š${new Date(book.created_at).toLocaleDateString()}
                    </div>
                    <div class="book-tags">
                        ${book.book_tags ? book.book_tags.map(bt => 
                            `<span class="book-tag">${bt.tags.name}</span>`
                        ).join('') : ''}
                    </div>
                </div>
            `).join('');
        }
    </script>
    
    <!-- Font Awesome å›¾æ ‡ -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>