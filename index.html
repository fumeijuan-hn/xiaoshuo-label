<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´è‡ªå®šä¹‰æ ‡ç­¾ç³»ç»Ÿ</title>
    
    <style>
        /* åŸºç¡€æ ·å¼å’Œé‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        /* ä¸»å†…å®¹åŒºåŸŸå¸ƒå±€ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡åŸºç¡€æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-3px);
        }

        .card-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f3f5;
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 10px;
            color: #3498db;
        }

        /* è¡¨å•åŸºç¡€æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* æŒ‰é’®åŸºç¡€æ ·å¼ */
        .submit-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            display: none;
            font-weight: 500;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #bdc3c7;
        }

        /* è¿æ¥çŠ¶æ€ */
        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        /* å¯¼èˆªæ ·å¼ */
        .main-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            padding: 0 10px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-btn:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .nav-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* é¡µé¢å®¹å™¨ */
        .page-container {
            position: relative;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ä¹¦ç±è¡¨å•ç‰¹å®šæ ·å¼ */
        .book-exists-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .existing-book-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .existing-book-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #856404;
        }

        .update-book-btn {
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 10px;
        }

        .update-book-btn:hover {
            background: #e67e22;
        }

        /* æ ‡ç­¾åŒºåŸŸæ ·å¼ */
        .tag-section {
            margin-top: 25px;
        }

        .tag-search-section {
            margin-bottom: 15px;
        }

        .tag-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .tag-chip {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .tag-chip:hover {
            background: #d5dbdb;
        }

        .tag-chip.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .selected-tags {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .selected-tags-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .selected-tags-list {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* åˆ›å»ºæ ‡ç­¾åŒºåŸŸ */
        .create-tag-section {
            border: 1px dashed #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            background: #f8f9fa;
        }

        .create-tag-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .create-tag-subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .create-tag-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .new-tag-input {
            flex: 3;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .add-tag-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s;
        }

        .add-tag-btn:hover {
            background: #2980b9;
        }

        .add-tag-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .new-tag-preview {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }

        /* ä¹¦ç±åˆ—è¡¨æ ·å¼ */
        .book-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .book-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }

        .book-item:hover {
            background-color: #f8f9fa;
        }

        .book-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .book-meta {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .book-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #495057;
        }

        /* æœç´¢ç•Œé¢ç‰¹å®šæ ·å¼ */
        .search-mode-selector {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .mode-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .mode-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .mode-option:hover {
            border-color: #3498db;
        }

        .mode-option input[type="radio"] {
            margin-right: 8px;
        }

        .mode-option input[type="radio"]:checked + .mode-label {
            color: #3498db;
            font-weight: 600;
        }

        .mode-label {
            font-weight: 500;
        }

        .search-section {
            display: none;
        }

        .search-section.active {
            display: block;
        }

        .input-hint {
            color: #6c757d;
            font-size: 0.85rem;
            margin: 5px 0 10px 0;
            font-style: italic;
        }

        .tags-input-container {
            position: relative;
        }

        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .selected-tags-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 20px;
        }

        .selected-tag-chip {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-tag-chip.bonus {
            background: #f39c12;
        }

        .selected-tag-chip.exclude {
            background: #e74c3c;
        }

        .remove-tag-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
            font-size: 0.8rem;
        }

        .similarity-options {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .search-stats {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            color: #6c757d;
        }

        .search-results-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .empty-search-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-search-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        .empty-search-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* æœç´¢ç»“æœé¡¹æ ·å¼ */
        .search-result-book {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .search-result-book:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .result-meta {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .match-score {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .score-badge {
            background: #2ecc71;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .core-match-count {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .tag-match-breakdown {
            margin: 12px 0;
        }

        .match-type {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .core-match-tags, .bonus-match-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .core-tag-match {
            background: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .bonus-tag-match {
            background: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .other-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .other-tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .book-description {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ä¹¦ç±æœç´¢è¾“å…¥æ¡† */
        .book-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .book-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .book-search-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .book-search-item:hover {
            background: #f8f9fa;
        }

        .book-search-item:last-child {
            border-bottom: none;
        }

        /* æ‚¬æµ®æ ‡ç­¾æœç´¢ç»“æœ */
        .floating-tag-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-top: 5px;
            padding: 15px;
        }

        .floating-tag-results.active {
            display: block;
        }

        .floating-tag-category {
            margin-bottom: 15px;
        }

        .floating-category-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #f0f3f5;
        }

        .floating-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .floating-tag-chip {
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .floating-tag-chip:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .floating-tag-chip.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .no-tags-found {
            text-align: center;
            color: #6c757d;
            padding: 20px;
            font-style: italic;
        }

        /* å‚è€ƒä¹¦ç±ä¿¡æ¯æ˜¾ç¤ºæ ·å¼ */
        .reference-book-display {
            background: #e8f4fc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .reference-book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .reference-book-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .reference-book-meta {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .reference-book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .reference-tag {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .clear-reference-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clear-reference-btn:hover {
            background: #c0392b;
        }

        /* ç§»é™¤å¸¸ç”¨æ ‡ç­¾çš„æ ·å¼ */
        .quick-tags {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“š å°è¯´è‡ªå®šä¹‰æ ‡ç­¾ç³»ç»Ÿ</h1>
            <p class="subtitle">æ·»åŠ æ‚¨å–œæ¬¢çš„å°è¯´çš„æ ‡ç­¾ä¿¡æ¯å§ <span id="connection-status" class="connection-status status-disconnected">æœªè¿æ¥</span></p>
        </header>
        
        <!-- å¯¼èˆªèœå• -->
        <nav class="main-nav" id="main-nav">
            <button class="nav-btn active" data-page="book-form">ğŸ“– æ·»åŠ å°è¯´</button>
            <button class="nav-btn" data-page="search">ğŸ” ä»£é¤æœç´¢</button>
        </nav>
        
        <!-- é¡µé¢å®¹å™¨ -->
        <div class="page-container">
            <!-- æ·»åŠ å°è¯´é¡µé¢ -->
            <div id="book-form-page" class="page active">
                <div class="main-content">
                    <!-- å·¦ä¾§ï¼šæ·»åŠ å°è¯´è¡¨å• -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“– æ·»åŠ æ–°å°è¯´</h2>
                        
                        <form id="book-form">
                            <div class="form-group">
                                <label for="title">ä¹¦å *</label>
                                <input type="text" id="title" required placeholder="è¯·è¾“å…¥å°è¯´ä¹¦å">
                                <div id="book-exists-message" class="book-exists-message"></div>
                            </div>
                            
                            <div id="existing-book-info" class="existing-book-info">
                                <div class="existing-book-title">ã€Š<span id="existing-book-name"></span>ã€‹å·²å­˜åœ¨äºæ•°æ®åº“ä¸­</div>
                                <div id="existing-book-details"></div>
                                <button type="button" id="update-book-btn" class="update-book-btn">æ›´æ–°ä¹¦ç±ä¿¡æ¯</button>
                            </div>
                            
                            <div class="form-group">
                                <label for="author">ä½œè€…</label>
                                <input type="text" id="author" placeholder="è¯·è¾“å…¥ä½œè€…å§“å">
                            </div>
                            
                            <div class="form-group">
                                <label for="platform">å‘å¸ƒå¹³å°</label>
                                <select id="platform">
                                    <option value="">è¯·é€‰æ‹©å¹³å°</option>
                                    <option value="èµ·ç‚¹">èµ·ç‚¹ä¸­æ–‡ç½‘</option>
                                    <option value="æ™‹æ±Ÿ">æ™‹æ±Ÿæ–‡å­¦åŸ</option>
                                    <option value="çºµæ¨ª">çºµæ¨ªä¸­æ–‡ç½‘</option>
                                    <option value="ç•ªèŒ„">ç•ªèŒ„å°è¯´</option>
                                    <option value="ä¸ƒçŒ«">ä¸ƒçŒ«å°è¯´</option>
                                    <option value="å…¶ä»–">å…¶ä»–å¹³å°</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="description">å°è¯´ç®€ä»‹</label>
                                <textarea id="description" placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™æœ¬å°è¯´çš„ä¸»è¦å†…å®¹..."></textarea>
                            </div>
                            
                            <!-- æ ‡ç­¾é€‰æ‹©åŒºåŸŸ -->
                            <div class="tag-section">
                                <h3>ğŸ·ï¸ é€‰æ‹©æ ‡ç­¾</h3>
                                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">é€‰æ‹©é€‚åˆè¿™æœ¬å°è¯´çš„æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰</p>
                                
                                <!-- æ ‡ç­¾æœç´¢ -->
                                <div class="tag-search-section">
                                    <div class="tags-input-container">
                                        <input type="text" id="tag-search" class="tag-search-input" placeholder="æœç´¢æ ‡ç­¾...">
                                        <div id="floating-tag-results" class="floating-tag-results"></div>
                                    </div>
                                </div>

                                <!-- å¿«é€Ÿå¸¸ç”¨æ ‡ç­¾ - å·²éšè— -->
                                <div class="quick-tags" id="quick-tags">
                                    <div style="color: #666; width: 100%;">å¸¸ç”¨æ ‡ç­¾åŠ è½½ä¸­...</div>
                                </div>

                                <!-- æ ‡ç­¾åˆ†ç±»æ˜¾ç¤º -->
                                <div id="tag-suggestions">
                                    <div style="color: #666;">åŠ è½½æ ‡ç­¾ä¸­...</div>
                                </div>
                                
                                <div class="selected-tags">
                                    <div class="selected-tags-title">å·²é€‰æ ‡ç­¾ï¼š</div>
                                    <div id="selected-tags-list" class="selected-tags-list">æš‚æ— </div>
                                </div>
                            </div>

                            <!-- åˆ›å»ºæ–°æ ‡ç­¾åŒºåŸŸ -->
                            <div class="create-tag-section">
                                <h4 class="create-tag-title">â• åˆ›å»ºæ–°æ ‡ç­¾</h4>
                                <p class="create-tag-subtitle">è¾“å…¥æ ‡ç­¾åç§°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†ç±»</p>
                                
                                <div class="create-tag-input">
                                    <input type="text" id="new-tag-name" class="new-tag-input" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°">
                                    <button type="button" id="add-tag-btn" class="add-tag-btn">åˆ›å»º</button>
                                </div>
                                
                                <div id="auto-category-preview" class="new-tag-preview">
                                    <strong>ç³»ç»Ÿåˆ†ç±»ï¼š</strong>
                                    <span id="predicted-category">æ­£åœ¨åˆ†æ...</span>
                                </div>
                                
                                <div id="create-tag-message" style="margin-top: 10px; font-size: 14px;"></div>
                            </div>
                            
                            <button type="submit" id="submit-btn" class="submit-btn">æäº¤å°è¯´ä¿¡æ¯</button>
                        </form>
                        
                        <div id="message" class="message"></div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šå°è¯´åˆ—è¡¨ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“‹ å·²æ·»åŠ çš„å°è¯´</h2>
                        <div class="book-list" id="book-list">
                            <div class="empty-state">
                                <div>ğŸ“š</div>
                                <p>æš‚æ— å°è¯´ä¿¡æ¯</p>
                                <p style="font-size: 0.9rem; margin-top: 10px;">æ·»åŠ çš„å°è¯´å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æœç´¢é¡µé¢ -->
            <div id="search-page" class="page">
                <div class="main-content">
                    <!-- å·¦ä¾§ï¼šæœç´¢ç•Œé¢ -->
                    <div class="card">
                        <h2 class="card-title">ğŸœ ç²¾å‡†ä»£é¤æœç´¢</h2>
                        
                        <!-- æœç´¢æ¨¡å¼é€‰æ‹© -->
                        <div class="search-mode-selector">
                            <div class="mode-options">
                                <label class="mode-option">
                                    <input type="radio" name="search-mode" value="core-tags" checked>
                                    <span class="mode-label">ğŸ¯ æ ¸å¿ƒæ ‡ç­¾åŒ¹é…</span>
                                </label>
                                <label class="mode-option">
                                    <input type="radio" name="search-mode" value="book-based">
                                    <span class="mode-label">ğŸ“– åŸºäºä¹¦ç±æœç´¢</span>
                                </label>
                            </div>
                        </div>

                        <!-- æ ¸å¿ƒæ ‡ç­¾æœç´¢åŒºåŸŸ -->
                        <div id="core-tags-search" class="search-section active">
                            <div class="form-group">
                                <label>ğŸ¯ æ ¸å¿ƒæ ‡ç­¾ï¼ˆå¿…é¡»åŒ…å«ï¼‰</label>
                                <p class="input-hint">é€‰æ‹©æœ€èƒ½ä»£è¡¨ä½ æƒ³è¦çš„ç‰¹å¾ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆåŒ¹é…è¿™äº›æ ‡ç­¾</p>
                                <div class="tags-input-container">
                                    <input type="text" id="core-tags-search-input" class="tag-search-input" placeholder="æœç´¢æˆ–é€‰æ‹©æ ¸å¿ƒæ ‡ç­¾...">
                                    <div id="core-tags-results" class="floating-tag-results"></div>
                                </div>
                                <div id="selected-core-tags" class="selected-tags-chips"></div>
                            </div>

                            <div class="form-group">
                                <label>ğŸ’« åŠ åˆ†æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
                                <p class="input-hint">æœ‰è¿™äº›æ ‡ç­¾ä¼šæé«˜åŒ¹é…åˆ†æ•°ï¼Œä½†æ²¡æœ‰ä¹Ÿä¸ä¼šæ’é™¤</p>
                                <div class="tags-input-container">
                                    <input type="text" id="bonus-tags-search-input" class="tag-search-input" placeholder="æœç´¢åŠ åˆ†æ ‡ç­¾...">
                                    <div id="bonus-tags-results" class="floating-tag-results"></div>
                                </div>
                                <div id="selected-bonus-tags" class="selected-tags-chips"></div>
                            </div>

                            <div class="form-group">
                                <label>ğŸš« æ’é™¤æ ‡ç­¾ï¼ˆé¿é›·ï¼‰</label>
                                <p class="input-hint">åŒ…å«è¿™äº›æ ‡ç­¾çš„å°è¯´ä¼šè¢«ç›´æ¥æ’é™¤</p>
                                <div class="tags-input-container">
                                    <input type="text" id="exclude-tags-search-input" class="tag-search-input" placeholder="æœç´¢éœ€è¦æ’é™¤çš„æ ‡ç­¾...">
                                    <div id="exclude-tags-results" class="floating-tag-results"></div>
                                </div>
                                <div id="selected-exclude-tags" class="selected-tags-chips"></div>
                            </div>
                        </div>

                        <!-- åŸºäºä¹¦ç±æœç´¢åŒºåŸŸ -->
                        <div id="book-based-search" class="search-section">
                            <div class="form-group">
                                <label>æœç´¢å‚è€ƒä¹¦ç±</label>
                                <div class="tags-input-container">
                                    <input type="text" id="reference-book-search" class="book-search-input" placeholder="è¾“å…¥å°è¯´ä¹¦åæœç´¢...">
                                    <div id="reference-book-results" class="book-search-results"></div>
                                </div>
                            </div>
                            
                            <div class="similarity-options">
                                <label>åŒ¹é…å¼ºåº¦ï¼š</label>
                                <label><input type="radio" name="similarity-level" value="high" checked> é«˜åº¦ç›¸ä¼¼</label>
                                <label><input type="radio" name="similarity-level" value="medium"> ä¸­ç­‰ç›¸ä¼¼</label>
                                <label><input type="radio" name="similarity-level" value="broad"> å¹¿æ³›ç›¸ä¼¼</label>
                            </div>

                            <!-- å‚è€ƒä¹¦ç±ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="reference-book-display" class="reference-book-display" style="display: none;">
                                <div class="reference-book-header">
                                    <div>
                                        <div class="reference-book-title" id="reference-book-display-title"></div>
                                        <div class="reference-book-meta" id="reference-book-display-meta"></div>
                                    </div>
                                    <button type="button" id="clear-reference-btn" class="clear-reference-btn">æ¸…é™¤</button>
                                </div>
                                <div class="reference-book-tags" id="reference-book-display-tags"></div>
                            </div>

                            <div id="book-not-found-message" class="message" style="display: none;">
                                <p>æœªæ‰¾åˆ°è¯¥ä¹¦ç±ï¼Œè¯·å…ˆ<a href="#" id="go-to-add-book" style="color: #3498db; text-decoration: underline;">æ·»åŠ è¯¥ä¹¦ç±ä¿¡æ¯</a></p>
                            </div>
                        </div>

                        <button id="start-search-btn" class="submit-btn">
                            å¼€å§‹å¯»æ‰¾ä»£é¤
                        </button>

                        <div id="search-stats" class="search-stats" style="display: none;">
                            æ­£åœ¨æœç´¢ç¬¦åˆæ¡ä»¶çš„ä»£é¤...
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šæœç´¢ç»“æœ -->
                    <div class="card">
                        <h2 class="card-title">ğŸ“‹ æœç´¢ç»“æœ</h2>
                        <div id="search-results-container" class="search-results-container">
                            <div class="empty-search-state">
                                <div>ğŸ”</div>
                                <h3>å¼€å§‹å¯»æ‰¾ä½ çš„ä»£é¤å°è¯´</h3>
                                <p>é€‰æ‹©æœç´¢æ¡ä»¶ï¼Œæ‰¾åˆ°ç¬¦åˆä½ å£å‘³çš„å°è¯´</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Supabaseå®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // åº”ç”¨é…ç½®
        const CONFIG = {
            supabase: {
                url: 'https://clwpzlioymonhhuelptk.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsd3B6bGlveW1vbmhodWVscHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MjgzMDQsImV4cCI6MjA3ODUwNDMwNH0.YZ58wm9t-XfEwMd9xylfDI4dcOxdDBaZQOYFRsYHrPs'
            },
            app: {
                maxTagsPerBook: 20,
                searchResultLimit: 20,
                popularTagsLimit: 50
            }
        };

        // å…¨å±€å˜é‡
        let supabaseClient = null;
        let allTags = [];
        let allBooks = [];

        // ä¹¦ç±è¡¨å•çš„å…¨å±€å˜é‡
        let bookFormSelectedTags = [];
        let existingBook = null;

        // æœç´¢é¡µé¢çš„å…¨å±€å˜é‡
        let searchState = {
            coreTags: [],
            bonusTags: [],
            excludeTags: [],
            currentMode: 'core-tags',
            referenceBook: null
        };

        // å·¥å…·å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showMessage(text, type, elementId = 'message') {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–Supabase
            await initSupabase();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åŠ è½½åˆå§‹æ•°æ®
            await loadInitialData();
        });

        // åˆå§‹åŒ–Supabase
        async function initSupabase() {
            try {
                supabaseClient = supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);
                
                // æµ‹è¯•è¿æ¥
                const { data, error } = await supabaseClient
                    .from('books')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                document.getElementById('connection-status').className = 'connection-status status-connected';
                console.log('Supabaseè¿æ¥æˆåŠŸ');
                return true;
                
            } catch (error) {
                console.error('Supabaseè¿æ¥å¤±è´¥:', error);
                document.getElementById('connection-status').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('connection-status').className = 'connection-status status-disconnected';
                return false;
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å¯¼èˆªæŒ‰é’®
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    switchPage(page);
                });
            });

            // æœç´¢æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('input[name="search-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    searchState.currentMode = this.value;
                    switchSearchMode(this.value);
                });
            });

            // è®¾ç½®ä¹¦ç±è¡¨å•äº‹ä»¶
            setupBookFormEvents();
            
            // è®¾ç½®æœç´¢äº‹ä»¶
            setupSearchEvents();
        }

        // è®¾ç½®ä¹¦ç±è¡¨å•äº‹ä»¶
        function setupBookFormEvents() {
            const form = document.getElementById('book-form');
            const titleInput = document.getElementById('title');
            const tagSearchInput = document.getElementById('tag-search');
            const addTagBtn = document.getElementById('add-tag-btn');
            const updateBookBtn = document.getElementById('update-book-btn');

            // è¡¨å•æäº¤
            form.addEventListener('submit', handleFormSubmit);
            
            // ä¹¦åæ£€æŸ¥ - ä¼˜åŒ–ï¼šå®æ—¶æ£€æŸ¥
            titleInput.addEventListener('input', function() {
                const title = this.value.trim();
                if (title.length > 0) {
                    // ç«‹å³æ˜¾ç¤ºæ£€æŸ¥çŠ¶æ€
                    document.getElementById('book-exists-message').textContent = 'æ£€æŸ¥ä¸­...';
                    document.getElementById('book-exists-message').style.display = 'block';
                    
                    // ä½¿ç”¨é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                    clearTimeout(window.tagSearchTimeout);
                    window.tagSearchTimeout = setTimeout(async () => {
                        existingBook = await checkBookExists(title);
                        if (existingBook) {
                            showBookExistsMessage(existingBook);
                        } else {
                            hideBookExistsMessage();
                        }
                    }, 300);
                } else {
                    hideBookExistsMessage();
                }
            });
            
            // æ ‡ç­¾æœç´¢ - ä¼˜åŒ–ï¼šæ‚¬æµ®æ˜¾ç¤ºæœç´¢ç»“æœ
            tagSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                const resultsContainer = document.getElementById('floating-tag-results');
                
                if (searchTerm.length < 1) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.remove('active');
                    return;
                }
                
                // ç«‹å³æ˜¾ç¤ºæœç´¢çŠ¶æ€
                resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æœç´¢ä¸­...</div>';
                resultsContainer.classList.add('active');
                
                // ä½¿ç”¨é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                clearTimeout(window.tagSearchTimeout);
                window.tagSearchTimeout = setTimeout(() => {
                    const searchResults = searchTags(searchTerm, 50); // æ˜¾ç¤ºæ›´å¤šç»“æœ
                    displayFloatingTagResults(searchResults, resultsContainer, 'book-form');
                }, 300);
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tags-input-container')) {
                    document.getElementById('floating-tag-results').classList.remove('active');
                }
            });
            
            // åˆ›å»ºæ–°æ ‡ç­¾
            addTagBtn.addEventListener('click', handleCreateNewTag);
            
            // æ›´æ–°ç°æœ‰ä¹¦ç±
            updateBookBtn.addEventListener('click', handleUpdateExistingBook);
            
            // å®æ—¶åˆ†ç±»é¢„è§ˆ
            document.getElementById('new-tag-name').addEventListener('input', async function() {
                const tagName = this.value.trim();
                const preview = document.getElementById('auto-category-preview');
                
                if (tagName) {
                    const predictedCategory = predictCategory(tagName);
                    document.getElementById('predicted-category').textContent = predictedCategory;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });

            // å¤„ç†è¡¨å•æäº¤
            async function handleFormSubmit(event) {
                event.preventDefault();
                
                if (existingBook) {
                    await handleUpdateExistingBook();
                    return;
                }
                
                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'æäº¤ä¸­...';
                submitBtn.disabled = true;
                
                const formData = {
                    title: document.getElementById('title').value.trim(),
                    author: document.getElementById('author').value.trim(),
                    platform: document.getElementById('platform').value,
                    description: document.getElementById('description').value.trim(),
                    submitted_by: 'user_' + Date.now()
                };
                
                if (!formData.title) {
                    showMessage('è¯·å¡«å†™ä¹¦åï¼', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    return;
                }
                
                try {
                    const result = await addBook(formData, bookFormSelectedTags);
                    
                    if (result.success) {
                        showMessage(`âœ… æˆåŠŸæ·»åŠ ã€Š${formData.title}ã€‹åˆ°æ•°æ®åº“ï¼`, 'success');
                        form.reset();
                        bookFormSelectedTags = [];
                        updateBookFormSelectedTagsDisplay();
                        document.querySelectorAll('.tag-chip.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        await loadBooks();
                    } else {
                        if (result.message.includes('å·²å­˜åœ¨')) {
                            existingBook = await checkBookExists(formData.title);
                            if (existingBook) {
                                showBookExistsMessage(existingBook);
                            }
                        } else {
                            showMessage('æäº¤å¤±è´¥ï¼š' + result.message, 'error');
                        }
                    }
                } catch (error) {
                    console.error('æäº¤é”™è¯¯:', error);
                    showMessage('æäº¤å¤±è´¥ï¼š' + error.message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
            
            function showBookExistsMessage(book) {
                const messageDiv = document.getElementById('book-exists-message');
                const existingBookInfo = document.getElementById('existing-book-info');
                const existingBookName = document.getElementById('existing-book-name');
                const existingBookDetails = document.getElementById('existing-book-details');
                
                messageDiv.textContent = 'æ­¤ä¹¦å·²å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œæ‚¨å¯ä»¥æ›´æ–°ä¿¡æ¯æˆ–æ·»åŠ æ ‡ç­¾';
                messageDiv.style.display = 'block';
                
                existingBookName.textContent = book.title;
                document.getElementById('author').value = book.author || '';
                document.getElementById('platform').value = book.platform || '';
                document.getElementById('description').value = book.description || '';
                
                bookFormSelectedTags = [];
                if (book.book_tags && book.book_tags.length > 0) {
                    book.book_tags.forEach(bt => {
                        bookFormSelectedTags.push(bt.tags);
                    });
                }
                updateBookFormSelectedTagsDisplay();
                
                document.querySelectorAll('.tag-chip').forEach(el => {
                    el.classList.remove('selected');
                });
                bookFormSelectedTags.forEach(tag => {
                    const tagElement = document.querySelector(`.tag-chip[data-tag-id="${tag.id}"]`);
                    if (tagElement) {
                        tagElement.classList.add('selected');
                    }
                });
                
                let detailsHtml = '';
                if (book.author) detailsHtml += `<div>ä½œè€…: ${book.author}</div>`;
                if (book.platform) detailsHtml += `<div>å¹³å°: ${book.platform}</div>`;
                if (book.book_tags && book.book_tags.length > 0) {
                    detailsHtml += `<div>ç°æœ‰æ ‡ç­¾: ${book.book_tags.map(bt => bt.tags.name).join(', ')}</div>`;
                }
                
                existingBookDetails.innerHTML = detailsHtml;
                existingBookInfo.style.display = 'block';
                document.getElementById('submit-btn').textContent = 'æ›´æ–°ä¹¦ç±ä¿¡æ¯';
            }
            
            function hideBookExistsMessage() {
                document.getElementById('book-exists-message').style.display = 'none';
                document.getElementById('existing-book-info').style.display = 'none';
                existingBook = null;
                document.getElementById('submit-btn').textContent = 'æäº¤å°è¯´ä¿¡æ¯';
            }
            
            async function handleUpdateExistingBook() {
                if (!existingBook) {
                    showMessage('æœªæ‰¾åˆ°è¦æ›´æ–°çš„ä¹¦ç±', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'æ›´æ–°ä¸­...';
                submitBtn.disabled = true;
                
                try {
                    const updateData = {
                        author: document.getElementById('author').value.trim(),
                        platform: document.getElementById('platform').value,
                        description: document.getElementById('description').value.trim()
                    };
                    
                    const result = await updateBook(existingBook.id, updateData, bookFormSelectedTags);
                    
                    if (result.success) {
                        showMessage(`âœ… æˆåŠŸæ›´æ–°ã€Š${existingBook.title}ã€‹çš„ä¿¡æ¯`, 'success');
                        document.getElementById('book-form').reset();
                        bookFormSelectedTags = [];
                        updateBookFormSelectedTagsDisplay();
                        document.querySelectorAll('.tag-chip.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        hideBookExistsMessage();
                        await loadBooks();
                    } else {
                        showMessage('æ›´æ–°å¤±è´¥ï¼š' + result.message, 'error');
                    }
                } catch (error) {
                    console.error('æ›´æ–°ä¹¦ç±å¤±è´¥:', error);
                    showMessage('æ›´æ–°å¤±è´¥ï¼š' + error.message, 'error');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
            
            async function handleCreateNewTag() {
                const nameInput = document.getElementById('new-tag-name');
                let tagName = nameInput.value.trim();
                
                if (!tagName) {
                    showCreateTagMessage('è¯·è¾“å…¥æ ‡ç­¾åç§°', 'error');
                    return;
                }
                
                if (tagName.length > 20) {
                    showCreateTagMessage('æ ‡ç­¾åç§°ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦', 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºæ ‡ç­¾åº“ä¸­
                const existingTag = allTags.find(tag => 
                    tag.name.toLowerCase() === tagName.toLowerCase()
                );
                
                if (existingTag) {
                    showCreateTagMessage(`æ ‡ç­¾ "${tagName}" å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥é€‰æ‹©ä½¿ç”¨`, 'error');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨äºå·²é€‰æ ‡ç­¾ä¸­
                const existsInSelected = bookFormSelectedTags.some(tag => tag.name === tagName);
                if (existsInSelected) {
                    showCreateTagMessage('è¯¥æ ‡ç­¾å·²å­˜åœ¨äºå·²é€‰æ ‡ç­¾ä¸­', 'error');
                    return;
                }
                
                const predictedCategory = predictCategory(tagName);
                const result = await createTag(tagName, predictedCategory);
                
                if (result.success) {
                    showCreateTagMessage(`âœ… å·²åˆ›å»ºæ ‡ç­¾: ${tagName} (${predictedCategory})`, 'success');
                    addExistingTagToBookForm(result.tag);
                    nameInput.value = '';
                    document.getElementById('auto-category-preview').style.display = 'none';
                    await loadTagSuggestions();
                } else {
                    showCreateTagMessage('åˆ›å»ºæ ‡ç­¾å¤±è´¥: ' + result.message, 'error');
                }
            }
            
            function addExistingTagToBookForm(tag) {
                if (!bookFormSelectedTags.some(t => t.id === tag.id)) {
                    bookFormSelectedTags.push(tag);
                    updateBookFormSelectedTagsDisplay();
                    showCreateTagMessage(`å·²æ·»åŠ æ ‡ç­¾: ${tag.name}`, 'success');
                    // å…³é—­æœç´¢ç»“æœ
                    document.getElementById('floating-tag-results').classList.remove('active');
                    document.getElementById('tag-search').value = '';
                }
            }
            
            function updateBookFormSelectedTagsDisplay() {
                const container = document.getElementById('selected-tags-list');
                
                if (bookFormSelectedTags.length === 0) {
                    container.textContent = 'æš‚æ— ';
                    container.style.color = '#6c757d';
                } else {
                    container.textContent = bookFormSelectedTags.map(tag => tag.name).join(', ');
                    container.style.color = '#000';
                }
            }
            
            function showCreateTagMessage(text, type) {
                const messageDiv = document.getElementById('create-tag-message');
                messageDiv.textContent = text;
                messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
                messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
                messageDiv.style.padding = '8px';
                messageDiv.style.borderRadius = '4px';
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // è®¾ç½®æœç´¢äº‹ä»¶
        function setupSearchEvents() {
            // æ ‡ç­¾æœç´¢è®¾ç½® - ä½¿ç”¨æ‚¬æµ®æ˜¾ç¤º
            setupFloatingTagSearch('core-tags-search-input', 'core-tags-results', 'core');
            setupFloatingTagSearch('bonus-tags-search-input', 'bonus-tags-results', 'bonus');
            setupFloatingTagSearch('exclude-tags-search-input', 'exclude-tags-results', 'exclude');

            // ä¹¦ç±æœç´¢ - ä¼˜åŒ–ï¼šå®æ—¶æœç´¢å¹¶åŒæ­¥æ˜¾ç¤º
            const bookSearchInput = document.getElementById('reference-book-search');
            bookSearchInput.addEventListener('input', debounce(async function() {
                const searchTerm = this.value.trim();
                const resultsContainer = document.getElementById('reference-book-results');
                
                if (searchTerm.length < 1) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // ç«‹å³æ˜¾ç¤ºæœç´¢çŠ¶æ€
                resultsContainer.innerHTML = '<div style="padding: 10px; color: #666;">æœç´¢ä¸­...</div>';
                resultsContainer.style.display = 'block';
                
                const searchResults = await searchBooksByName(searchTerm, 10);
                displayBookSearchResults(searchResults, resultsContainer);
                resultsContainer.style.display = 'block';
            }, 500));

            // å¼€å§‹æœç´¢æŒ‰é’®
            document.getElementById('start-search-btn').addEventListener('click', () => {
                performSearch();
            });

            // æ¸…é™¤å‚è€ƒä¹¦ç±æŒ‰é’®
            document.getElementById('clear-reference-btn').addEventListener('click', function() {
                clearReferenceBook();
            });

            // è·³è½¬åˆ°æ·»åŠ ä¹¦ç±
            document.getElementById('go-to-add-book').addEventListener('click', function(e) {
                e.preventDefault();
                const bookName = document.getElementById('reference-book-search').value.trim();
                if (bookName) {
                    document.getElementById('title').value = bookName;
                }
                switchPage('book-form');
            });
        }

        function setupFloatingTagSearch(inputId, resultsId, type) {
            const input = document.getElementById(inputId);
            const results = document.getElementById(resultsId);
            
            input.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                if (searchTerm.length < 1) {
                    results.innerHTML = '';
                    results.classList.remove('active');
                    return;
                }
                
                const filteredTags = searchTags(searchTerm, 50);
                displayFloatingTagResults(filteredTags, results, type);
                results.classList.add('active');
            });
            
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    results.classList.remove('active');
                }, 200);
            });
        }

        function displayFloatingTagResults(tags, container, context) {
            if (tags.length === 0) {
                container.innerHTML = '<div class="no-tags-found">æœªæ‰¾åˆ°ç›¸å…³æ ‡ç­¾</div>';
                return;
            }
            
            // æŒ‰åˆ†ç±»åˆ†ç»„
            const tagsByCategory = {};
            tags.forEach(tag => {
                if (!tagsByCategory[tag.category]) {
                    tagsByCategory[tag.category] = [];
                }
                tagsByCategory[tag.category].push(tag);
            });
            
            let html = '';
            Object.keys(tagsByCategory).forEach(category => {
                html += `
                    <div class="floating-tag-category">
                        <div class="floating-category-title">${category}</div>
                        <div class="floating-tags-container">
                            ${tagsByCategory[category].map(tag => `
                                <div class="floating-tag-chip" data-tag-id="${tag.id}">
                                    ${tag.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.floating-tag-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const tagId = this.dataset.tagId;
                    const tag = allTags.find(t => t.id === tagId);
                    
                    if (tag) {
                        if (context === 'book-form') {
                            if (!bookFormSelectedTags.some(t => t.id === tag.id)) {
                                bookFormSelectedTags.push(tag);
                                updateBookFormSelectedTagsDisplay();
                                // åœ¨æ ‡ç­¾åˆ—è¡¨ä¸­ä¹Ÿè¦é€‰ä¸­
                                const tagChip = document.querySelector(`.tag-chip[data-tag-id="${tag.id}"]`);
                                if (tagChip) {
                                    tagChip.classList.add('selected');
                                }
                            }
                            // æ¸…ç©ºæœç´¢æ¡†å’Œç»“æœ
                            document.getElementById('tag-search').value = '';
                            container.classList.remove('active');
                        } else {
                            // æœç´¢é¡µé¢çš„æ ‡ç­¾æ·»åŠ 
                            addTagToSearch(tag, context);
                            document.getElementById(`${context}-tags-search-input`).value = '';
                            container.classList.remove('active');
                        }
                    }
                });
            });
        }

        function displayBookSearchResults(books, container) {
            if (books.length === 0) {
                container.innerHTML = '<div class="book-search-item">æœªæ‰¾åˆ°ç›¸å…³ä¹¦ç±</div>';
                return;
            }
            
            container.innerHTML = books.map(book => `
                <div class="book-search-item" data-book-id="${book.id}">
                    <div>
                        <strong>ã€Š${book.title}ã€‹</strong>
                        <div style="color: #6c757d; font-size: 0.8rem;">
                            ${book.author ? `ä½œè€…ï¼š${book.author} | ` : ''}
                            ${book.platform ? `å¹³å°ï¼š${book.platform} | ` : ''}
                            ${book.book_tags ? `æ ‡ç­¾ï¼š${book.book_tags.map(bt => bt.tags.name).join(', ')}` : ''}
                        </div>
                    </div>
                    <div style="color: #6c757d; font-size: 0.8rem;">ç‚¹å‡»é€‰æ‹©</div>
                </div>
            `).join('');
            
            container.querySelectorAll('.book-search-item').forEach(item => {
                item.addEventListener('click', function() {
                    const bookId = this.dataset.bookId;
                    const book = allBooks.find(b => b.id === bookId);
                    
                    if (book) {
                        selectReferenceBook(book);
                        document.getElementById('reference-book-search').value = '';
                        container.style.display = 'none';
                    }
                });
            });
        }

        function addTagToSearch(tag, type) {
            const tagArray = searchState[`${type}Tags`];
            const container = document.getElementById(`selected-${type}-tags`);
            
            if (tagArray.some(t => t.id === tag.id)) {
                return;
            }
            
            tagArray.push(tag);
            
            const tagChip = document.createElement('div');
            tagChip.className = `selected-tag-chip ${type}`;
            tagChip.innerHTML = `
                ${tag.name}
                <button class="remove-tag-btn" data-tag-id="${tag.id}" data-tag-type="${type}">
                    âŒ
                </button>
            `;
            
            container.appendChild(tagChip);
            
            tagChip.querySelector('.remove-tag-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                const tagId = this.dataset.tagId;
                const tagType = this.dataset.tagType;
                removeTagFromSearch(tagId, tagType);
            });
        }

        function removeTagFromSearch(tagId, type) {
            const tagArray = searchState[`${type}Tags`];
            const index = tagArray.findIndex(t => t.id === tagId);
            
            if (index > -1) {
                tagArray.splice(index, 1);
            }
            
            const container = document.getElementById(`selected-${type}-tags`);
            const chipToRemove = container.querySelector(`[data-tag-id="${tagId}"]`).parentElement;
            container.removeChild(chipToRemove);
        }

        function selectReferenceBook(book) {
            searchState.referenceBook = book;
            
            const displayContainer = document.getElementById('reference-book-display');
            const notFoundMessage = document.getElementById('book-not-found-message');
            
            // æ˜¾ç¤ºå‚è€ƒä¹¦ç±ä¿¡æ¯
            document.getElementById('reference-book-display-title').textContent = `ã€Š${book.title}ã€‹`;
            
            let metaInfo = [];
            if (book.author) metaInfo.push(`ä½œè€…ï¼š${book.author}`);
            if (book.platform) metaInfo.push(`å¹³å°ï¼š${book.platform}`);
            document.getElementById('reference-book-display-meta').textContent = metaInfo.join(' | ');
            
            // æ˜¾ç¤ºæ ‡ç­¾
            const tagsContainer = document.getElementById('reference-book-display-tags');
            if (book.book_tags && book.book_tags.length > 0) {
                tagsContainer.innerHTML = book.book_tags.map(bt => 
                    `<span class="reference-tag">${bt.tags.name}</span>`
                ).join('');
            } else {
                tagsContainer.innerHTML = '<span style="color: #6c757d; font-style: italic;">æš‚æ— æ ‡ç­¾</span>';
            }
            
            displayContainer.style.display = 'block';
            
            // éšè—æœªæ‰¾åˆ°æ¶ˆæ¯
            notFoundMessage.style.display = 'none';
            
            console.log('å·²é€‰æ‹©å‚è€ƒä¹¦ç±:', book.title);
        }

        function clearReferenceBook() {
            searchState.referenceBook = null;
            document.getElementById('reference-book-display').style.display = 'none';
            document.getElementById('reference-book-search').value = '';
            document.getElementById('book-not-found-message').style.display = 'none';
            
            // æ¸…ç©ºæœç´¢ç»“æœ
            document.getElementById('search-results-container').innerHTML = `
                <div class="empty-search-state">
                    <div>ğŸ”</div>
                    <h3>å¼€å§‹å¯»æ‰¾ä½ çš„ä»£é¤å°è¯´</h3>
                    <p>é€‰æ‹©æœç´¢æ¡ä»¶ï¼Œæ‰¾åˆ°ç¬¦åˆä½ å£å‘³çš„å°è¯´</p>
                </div>
            `;
            
            console.log('å·²æ¸…é™¤å‚è€ƒä¹¦ç±');
        }

        // é¡µé¢åˆ‡æ¢
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetPage = document.getElementById(`${pageId}-page`);
            const targetBtn = document.querySelector(`[data-page="${pageId}"]`);
            
            if (targetPage && targetBtn) {
                targetPage.classList.add('active');
                targetBtn.classList.add('active');
            }
            
            // åˆ‡æ¢åˆ°æœç´¢é¡µé¢æ—¶ï¼Œå¦‚æœä¹‹å‰æœ‰å‚è€ƒä¹¦ç±ï¼Œç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            if (pageId === 'search' && searchState.referenceBook) {
                selectReferenceBook(searchState.referenceBook);
            }
        }

        function switchSearchMode(mode) {
            document.querySelectorAll('.search-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${mode}-search`).classList.add('active');
            
            // é‡ç½®å‚è€ƒä¹¦ç±é€‰æ‹©ï¼ˆåªæœ‰åœ¨åˆ‡æ¢åˆ°éä¹¦ç±æœç´¢æ¨¡å¼æ—¶æ‰æ¸…é™¤ï¼‰
            if (mode !== 'book-based') {
                clearReferenceBook();
            }
        }

        // æ•°æ®åŠ è½½å‡½æ•°
        async function loadInitialData() {
            await loadAllTags();
            await loadBooks();
            await loadTagSuggestions();
        }

        async function loadAllTags() {
            try {
                const { data, error } = await supabaseClient
                    .from('tags')
                    .select('*')
                    .order('used_count', { ascending: false });
                
                if (error) throw error;
                allTags = data;
                
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error);
            }
        }

        async function loadBooks() {
            try {
                const { data, error } = await supabaseClient
                    .from('books')
                    .select(`
                        *,
                        book_tags (
                            tags (*)
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50); // åŠ è½½æ›´å¤šä¹¦ç±ç”¨äºæœç´¢
                
                if (error) throw error;
                
                allBooks = data;
                displayBooks(data);
                
            } catch (error) {
                console.error('åŠ è½½ä¹¦ç±å¤±è´¥:', error);
            }
        }

        function displayBooks(books) {
            const container = document.getElementById('book-list');
            
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ“š</div>
                        <p>æš‚æ— å°è¯´ä¿¡æ¯</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">æ·»åŠ çš„å°è¯´å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = books.map(book => `
                <div class="book-item">
                    <div class="book-title">ã€Š${book.title}ã€‹</div>
                    <div class="book-meta">
                        ${book.author ? `ä½œè€…ï¼š${book.author} | ` : ''}
                        ${book.platform ? `å¹³å°ï¼š${book.platform} | ` : ''}
                        æ·»åŠ æ—¶é—´ï¼š${new Date(book.created_at).toLocaleDateString()}
                    </div>
                    <div class="book-tags">
                        ${book.book_tags ? book.book_tags.map(bt => 
                            `<span class="book-tag">${bt.tags.name}</span>`
                        ).join('') : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadTagSuggestions() {
            const container = document.getElementById('tag-suggestions');
            container.innerHTML = '';
            
            const tagsByCategory = {};
            allTags.forEach(tag => {
                if (!tagsByCategory[tag.category]) {
                    tagsByCategory[tag.category] = [];
                }
                tagsByCategory[tag.category].push(tag);
            });
            
            Object.keys(tagsByCategory).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.marginBottom = '20px';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = category;
                categoryDiv.appendChild(categoryTitle);
                
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'tag-suggestions';
                
                tagsByCategory[category].forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag-chip';
                    tagElement.textContent = tag.name;
                    tagElement.title = `${tag.name} (${tag.category})`;
                    tagElement.setAttribute('data-tag-id', tag.id);
                    tagElement.addEventListener('click', function() {
                        const isSelected = this.classList.contains('selected');
                        if (isSelected) {
                            this.classList.remove('selected');
                            bookFormSelectedTags = bookFormSelectedTags.filter(t => t.id !== tag.id);
                        } else {
                            this.classList.add('selected');
                            if (!bookFormSelectedTags.some(t => t.id === tag.id)) {
                                bookFormSelectedTags.push(tag);
                            }
                        }
                        updateBookFormSelectedTagsDisplay();
                    });
                    tagsContainer.appendChild(tagElement);
                });
                
                categoryDiv.appendChild(tagsContainer);
                container.appendChild(categoryDiv);
            });
        }

        // æœç´¢åŠŸèƒ½
        async function performSearch() {
            const stats = document.getElementById('search-stats');
            const resultsContainer = document.getElementById('search-results-container');
            
            stats.style.display = 'block';
            stats.innerHTML = '<div class="loading-spinner"></div> æ­£åœ¨æœç´¢ç¬¦åˆæ¡ä»¶çš„ä»£é¤...';
            resultsContainer.innerHTML = '';
            
            try {
                let results = [];
                let searchDescription = '';
                
                switch (searchState.currentMode) {
                    case 'core-tags':
                        if (searchState.coreTags.length === 0 && searchState.bonusTags.length === 0) {
                            throw new Error('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœç´¢æ ‡ç­¾');
                        }
                        results = await searchByTags(
                            searchState.coreTags, 
                            searchState.bonusTags, 
                            searchState.excludeTags
                        );
                        searchDescription = `åŸºäº ${searchState.coreTags.length} ä¸ªæ ¸å¿ƒæ ‡ç­¾å’Œ ${searchState.bonusTags.length} ä¸ªåŠ åˆ†æ ‡ç­¾`;
                        break;
                        
                    case 'book-based':
                        if (!searchState.referenceBook) {
                            // å¦‚æœæ²¡æœ‰é€‰æ‹©å‚è€ƒä¹¦ç±ï¼Œå°è¯•æœç´¢
                            const bookName = document.getElementById('reference-book-search').value.trim();
                            if (!bookName) {
                                throw new Error('è¯·è¾“å…¥æˆ–é€‰æ‹©å‚è€ƒä¹¦ç±');
                            }
                            
                            const foundBooks = await searchBooksByName(bookName, 1);
                            if (foundBooks.length === 0) {
                                // æ˜¾ç¤ºå¼•å¯¼ä¿¡æ¯
                                document.getElementById('book-not-found-message').style.display = 'block';
                                stats.style.display = 'none';
                                return;
                            }
                            
                            searchState.referenceBook = foundBooks[0];
                            selectReferenceBook(foundBooks[0]);
                        }
                        
                        const similarityLevel = document.querySelector('input[name="similarity-level"]:checked').value;
                        results = await searchByReferenceBook(searchState.referenceBook, similarityLevel);
                        
                        // æ›´æ–°æœç´¢æè¿°
                        const levelText = {
                            'high': 'é«˜åº¦ç›¸ä¼¼',
                            'medium': 'ä¸­ç­‰ç›¸ä¼¼', 
                            'broad': 'å¹¿æ³›ç›¸ä¼¼'
                        }[similarityLevel];
                        searchDescription = `åŸºäºã€Š${searchState.referenceBook.title}ã€‹çš„${levelText}åŒ¹é…`;
                        break;
                }
                
                displaySearchResults(results, searchDescription);
                stats.innerHTML = `æ‰¾åˆ° ${results.length} ä¸ªç¬¦åˆæ¡ä»¶çš„ä»£é¤ (${searchDescription})`;
                
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                stats.innerHTML = `<div style="color: red;">æœç´¢å¤±è´¥: ${error.message}</div>`;
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <div>âš ï¸</div>
                        <h3>æœç´¢å¤±è´¥</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function displaySearchResults(results, searchDescription = '') {
            const container = document.getElementById('search-results-container');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div>ğŸ”</div>
                        <h3>æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä»£é¤</h3>
                        <p>${searchDescription || 'å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ä½¿ç”¨ä¸åŒçš„æœç´¢æ¨¡å¼'}</p>
                    </div>
                `;
                return;
            }
            
            // æ·»åŠ æœç´¢æè¿°
            let headerHtml = '';
            if (searchDescription) {
                headerHtml = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>æœç´¢æ¡ä»¶ï¼š</strong>${searchDescription}
                    </div>
                `;
            }
            
            container.innerHTML = headerHtml + results.map(result => `
                <div class="search-result-book">
                    <div class="result-header">
                        <div>
                            <div class="result-title">ã€Š${result.book.title}ã€‹</div>
                            <div class="result-meta">
                                ${result.book.author ? `ä½œè€…ï¼š${result.book.author} | ` : ''}
                                ${result.book.platform ? `å¹³å°ï¼š${result.book.platform} | ` : ''}
                                åŒ¹é…åº¦ï¼š${Math.round(result.score * 100)}%
                            </div>
                        </div>
                        <div class="match-score">
                            <span class="score-badge">${Math.round(result.score * 100)}%</span>
                            ${result.totalCoreTags > 0 ? 
                                `<span class="core-match-count">${result.coreMatchCount}/${result.totalCoreTags}</span>` : ''
                            }
                        </div>
                    </div>
                    
                    ${result.coreMatches.length > 0 ? `
                        <div class="tag-match-breakdown">
                            <div class="match-type">ğŸ¯ æ ¸å¿ƒåŒ¹é…ï¼š</div>
                            <div class="core-match-tags">
                                ${result.coreMatches.map(tag => 
                                    `<span class="core-tag-match">${tag.name}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${result.bonusMatches.length > 0 ? `
                        <div class="tag-match-breakdown">
                            <div class="match-type">ğŸ’« åŠ åˆ†åŒ¹é…ï¼š</div>
                            <div class="bonus-match-tags">
                                ${result.bonusMatches.map(tag => 
                                    `<span class="bonus-tag-match">${tag.name}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${result.book.description ? `
                        <div class="book-description">${result.book.description}</div>
                    ` : ''}
                </div>
            `).join('');
        }

        // æ•°æ®åº“æ“ä½œå‡½æ•°
        async function checkBookExists(title) {
            try {
                const { data, error } = await supabaseClient
                    .from('books')
                    .select(`
                        *,
                        book_tags (
                            tags (*)
                        )
                    `)
                    .ilike('title', title)
                    .limit(1);
                
                if (error) throw error;
                
                return data && data.length > 0 ? data[0] : null;
            } catch (error) {
                console.error('æ£€æŸ¥ä¹¦åå¤±è´¥:', error);
                return null;
            }
        }

        async function searchBooksByName(title, limit = 10) {
            try {
                const { data, error } = await supabaseClient
                    .from('books')
                    .select(`
                        *,
                        book_tags (
                            tags (*)
                        )
                    `)
                    .ilike('title', `%${title}%`)
                    .limit(limit);
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('æœç´¢ä¹¦ç±å¤±è´¥:', error);
                return [];
            }
        }

        async function addBook(bookData, selectedTags) {
            try {
                // å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existing = await checkBookExists(bookData.title);
                if (existing) {
                    return { success: false, message: 'ä¹¦ç±å·²å­˜åœ¨ï¼Œè¯·æ›´æ–°ä¿¡æ¯æˆ–æ·»åŠ æ ‡ç­¾' };
                }
                
                // 1. æ’å…¥ä¹¦ç±æ•°æ®
                const { data: book, error: bookError } = await supabaseClient
                    .from('books')
                    .insert([bookData])
                    .select();
                
                if (bookError) throw bookError;
                
                const bookId = book[0].id;
                
                // 2. æ’å…¥æ ‡ç­¾å…³è”
                if (selectedTags.length > 0) {
                    const bookTagInserts = selectedTags.map(tag => ({
                        book_id: bookId,
                        tag_id: tag.id
                    }));
                    
                    const { error: tagError } = await supabaseClient
                        .from('book_tags')
                        .insert(bookTagInserts);
                    
                    if (tagError) throw tagError;
                }
                
                return { success: true, message: 'ä¹¦ç±æ·»åŠ æˆåŠŸ', book: book[0] };
            } catch (error) {
                console.error('æ·»åŠ ä¹¦ç±å¤±è´¥:', error);
                if (error.code === '23505') { // å”¯ä¸€çº¦æŸè¿å
                    return { success: false, message: 'ä¹¦ç±å·²å­˜åœ¨ï¼Œè¯·æ›´æ–°ä¿¡æ¯æˆ–æ·»åŠ æ ‡ç­¾' };
                }
                return { success: false, message: `æ·»åŠ å¤±è´¥: ${error.message}` };
            }
        }

        async function updateBook(bookId, bookData, selectedTags) {
            try {
                // 1. æ›´æ–°ä¹¦ç±ä¿¡æ¯
                const { error: bookError } = await supabaseClient
                    .from('books')
                    .update(bookData)
                    .eq('id', bookId);
                
                if (bookError) throw bookError;
                
                // 2. æ›´æ–°æ ‡ç­¾å…³è”
                const { error: deleteError } = await supabaseClient
                    .from('book_tags')
                    .delete()
                    .eq('book_id', bookId);
                
                if (deleteError) throw deleteError;
                
                if (selectedTags.length > 0) {
                    const bookTagInserts = selectedTags.map(tag => ({
                        book_id: bookId,
                        tag_id: tag.id
                    }));
                    
                    const { error: insertError } = await supabaseClient
                        .from('book_tags')
                        .insert(bookTagInserts);
                    
                    if (insertError) throw insertError;
                }
                
                return { success: true, message: 'ä¹¦ç±æ›´æ–°æˆåŠŸ' };
            } catch (error) {
                console.error('æ›´æ–°ä¹¦ç±å¤±è´¥:', error);
                return { success: false, message: `æ›´æ–°å¤±è´¥: ${error.message}` };
            }
        }

        async function createTag(tagName, category) {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingTag = allTags.find(tag => 
                    tag.name.toLowerCase() === tagName.toLowerCase()
                );
                
                if (existingTag) {
                    return { success: false, message: 'æ ‡ç­¾å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥é€‰æ‹©ä½¿ç”¨', tag: existingTag };
                }
                
                // åˆ›å»ºæ–°æ ‡ç­¾
                const { data, error } = await supabaseClient
                    .from('tags')
                    .insert([{
                        name: tagName,
                        category: category,
                        description: '',
                        used_count: 0
                    }])
                    .select();
                
                if (error) throw error;
                
                const newTag = data[0];
                allTags.unshift(newTag);
                
                return { success: true, message: 'æ ‡ç­¾åˆ›å»ºæˆåŠŸ', tag: newTag };
            } catch (error) {
                console.error('åˆ›å»ºæ ‡ç­¾å¤±è´¥:', error);
                if (error.code === '23505') { // å”¯ä¸€çº¦æŸè¿å
                    return { success: false, message: 'æ ‡ç­¾å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥é€‰æ‹©ä½¿ç”¨' };
                }
                return { success: false, message: `åˆ›å»ºå¤±è´¥: ${error.message}` };
            }
        }

        function searchTags(keyword, limit = 10) {
            if (!keyword) return [];
            
            return allTags.filter(tag => 
                tag.name.toLowerCase().includes(keyword.toLowerCase())
            ).slice(0, limit);
        }

        function predictCategory(tagName) {
            const categoryKeywords = {
                'æ ¸å¿ƒè®¾å®š': ['ç©¿è¶Š', 'é‡ç”Ÿ', 'ç³»ç»Ÿ', 'æœ«ä¸–', 'æ˜Ÿé™…', 'ç„å¹»', 'ä»™ä¾ ', 'æ­¦ä¾ ', 'ç§‘å¹»'],
                'æ„Ÿæƒ…æ¨¡å¼': ['ç”œå® ', 'è™æ‹', 'æš—æ‹', 'å…ˆå©šåçˆ±', 'ç ´é•œé‡åœ†', 'é’æ¢…ç«¹é©¬'],
                'äººç‰©å…³ç³»': ['1v1', 'ç¾¤åƒ', 'å…„å¼Ÿ', 'å§å¦¹', 'å¸ˆå¾’', 'ä¸»ä»†', 'å¼ºå¼º'],
                'å™äº‹é£æ ¼': ['è½»æ¾', 'æ­£å‰§', 'æç¬‘', 'æ‚¬ç–‘', 'ææ€–', 'æ²»æ„ˆ', 'æ²™é›•'],
                'é˜…è¯»æç¤º': ['HE', 'BE', 'SC', 'æœ‰è‚‰', 'æ¸…æ°´', 'å®Œç»“', 'è¿è½½']
            };
            
            const lowerTagName = tagName.toLowerCase();
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(keyword => lowerTagName.includes(keyword.toLowerCase()))) {
                    return category;
                }
            }
            
            return 'å…¶ä»–';
        }

        async function searchByTags(coreTags, bonusTags, excludeTags) {
            try {
                // è·å–æ‰€æœ‰ä¹¦ç±åŠå…¶æ ‡ç­¾
                const { data: allBooks, error } = await supabaseClient
                    .from('books')
                    .select(`
                        *,
                        book_tags ( tags (*) )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // è®¡ç®—åŒ¹é…åº¦
                const results = allBooks.map(book => {
                    const bookTagIds = book.book_tags.map(bt => bt.tags.id);
                    
                    // æ ¸å¿ƒæ ‡ç­¾åŒ¹é…
                    const coreMatches = coreTags.filter(tag => 
                        bookTagIds.includes(tag.id)
                    );
                    
                    // åŠ åˆ†æ ‡ç­¾åŒ¹é…
                    const bonusMatches = bonusTags.filter(tag =>
                        bookTagIds.includes(tag.id)
                    );
                    
                    // æ’é™¤æ ‡ç­¾æ£€æŸ¥
                    const hasExcludedTags = excludeTags.some(tag =>
                        bookTagIds.includes(tag.id)
                    );
                    
                    if (hasExcludedTags) {
                        return null;
                    }
                    
                    // è®¡ç®—åŒ¹é…åˆ†æ•°
                    const coreScore = coreTags.length > 0 ? 
                        coreMatches.length / coreTags.length : 0;
                    const bonusScore = bonusMatches.length * 0.1;
                    const totalScore = coreScore + bonusScore;
                    
                    return {
                        book,
                        score: totalScore,
                        coreMatches,
                        bonusMatches,
                        coreMatchCount: coreMatches.length,
                        totalCoreTags: coreTags.length
                    };
                }).filter(result => result !== null && result.score > 0)
                  .sort((a, b) => b.score - a.score)
                  .slice(0, 20);
                
                return results;
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                throw error;
            }
        }

        async function searchByReferenceBook(referenceBook, similarityLevel) {
            try {
                if (!referenceBook || !referenceBook.book_tags) {
                    throw new Error('å‚è€ƒä¹¦ç±æ²¡æœ‰æ ‡ç­¾ä¿¡æ¯');
                }
                
                const referenceTags = referenceBook.book_tags.map(bt => bt.tags);
                
                // æ ¹æ®ç›¸ä¼¼åº¦çº§åˆ«è°ƒæ•´æœç´¢ç­–ç•¥
                let coreTags = [];
                let bonusTags = [];
                
                if (similarityLevel === 'high') {
                    // é«˜åº¦ç›¸ä¼¼ï¼šä½¿ç”¨æ‰€æœ‰æ ‡ç­¾ä½œä¸ºæ ¸å¿ƒæ ‡ç­¾
                    coreTags = referenceTags;
                } else if (similarityLevel === 'medium') {
                    // ä¸­ç­‰ç›¸ä¼¼ï¼šä½¿ç”¨éƒ¨åˆ†æ ¸å¿ƒæ ‡ç­¾
                    coreTags = referenceTags.slice(0, Math.ceil(referenceTags.length * 0.7));
                    bonusTags = referenceTags.slice(Math.ceil(referenceTags.length * 0.7));
                } else if (similarityLevel === 'broad') {
                    // å¹¿æ³›ç›¸ä¼¼ï¼šæ‰€æœ‰æ ‡ç­¾éƒ½ä½œä¸ºåŠ åˆ†æ ‡ç­¾
                    bonusTags = referenceTags;
                }
                
                console.log(`åŸºäºã€Š${referenceBook.title}ã€‹æœç´¢ï¼Œç›¸ä¼¼åº¦: ${similarityLevel}`);
                console.log('æ ¸å¿ƒæ ‡ç­¾:', coreTags.map(t => t.name));
                console.log('åŠ åˆ†æ ‡ç­¾:', bonusTags.map(t => t.name));
                
                const results = await searchByTags(coreTags, bonusTags, []);
                
                // æ’é™¤å‚è€ƒä¹¦ç±æœ¬èº«
                const filteredResults = results.filter(result => result.book.id !== referenceBook.id);
                
                console.log(`æ‰¾åˆ° ${filteredResults.length} ä¸ªç›¸å…³ä»£é¤`);
                return filteredResults;
                
            } catch (error) {
                console.error('åŸºäºä¹¦ç±æœç´¢å¤±è´¥:', error);
                throw error;
            }
        }
    </script>
</body>
</html>